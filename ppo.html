<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>PPO ä»£ç è§£è¯» Â·        <h2>ä¸ºä»€ä¹ˆé€‰æ‹© PPOï¼Ÿ</h2>
        <p>
          PPO é€šè¿‡å¯¹ç­–ç•¥æ›´æ–°è¿›è¡Œè£å‰ª (clipping) é™åˆ¶æ–°æ—§ç­–ç•¥çš„å·®è·ï¼Œå…¼é¡¾äº†
          <span class="annotation-target              <circle cx="45" cy="25" r="30" class="annotation-circle" />
              <path d="M 75 25 L 110 15" class="annotation-line" />
              <text x="85" y="8" font-size="10" fill="#b45309" font-weight="700">è£å‰ªæœºåˆ¶</text>ata-annotation="stability">
            <span class="highlight-term">è®­ç»ƒç¨³å®šæ€§</span>
            <svg class="annotation-svg" width="120" height="80" viewBox="0 0 120 80">
              <defs>
                <marker id="arrowhead" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
                  <polygon points="0 0, 10 3, 0 6" class="annotation-arrow" />
                </marker>
              </defs>
              <circle cx="40" cy="40" r="35" class="annotation-circle" />
              <path d="M 50 15 Q 70 20, 85 0" class="annotation-line" />
              <text x="60" y="8" font-size="11" fill="#b45309" font-weight="700">å…³é”®æ¦‚å¿µ</text>
            </svg>
          </span>
          ä¸æ ·æœ¬æ•ˆç‡ã€‚
          å®ƒæ²¿è¢­äº† TRPO "ä¿¡èµ–åŸŸ" çš„æ€æƒ³ï¼Œå´é¿å…äº†æ˜‚è´µçš„äºŒé˜¶ä¼˜åŒ–ã€‚æ ¸å¿ƒç›®æ ‡å‡½æ•°ï¼š
        </p>

        <div class="pointer-box" onclick="document.getElementById('clip-loss').scrollIntoView({behavior: 'smooth'})">
          <span class="pointer-arrow">â†’</span>
          <span>æŸ¥çœ‹ä»£ç ç‰‡æ®µ Aï¼šè£å‰ªæŸå¤±å‡½æ•°</span>
        </div>
        <div class="pointer-box" onclick="document.getElementById('ratio-calc').scrollIntoView({behavior: 'smooth'})">
          <span class="pointer-arrow">â†’</span>
          <span>æŸ¥çœ‹ä»£ç ç‰‡æ®µ Bï¼šæ¦‚ç‡æ¯”ç‡è®¡ç®—</span>
        </div>Ori</title>
  <meta name="description" content="PPO ç­–ç•¥ä¼˜åŒ–ä»£ç è§£è¯»ï¼ŒåŒ…å«æ ¸å¿ƒæ¦‚å¿µã€ç®—æ³•æµç¨‹ä¸å·¥ç¨‹å®è·µã€‚">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Merriweather:wght@700&family=Space+Grotesk:wght@400;500;600&display=swap"
    rel="stylesheet">
  <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
  <link rel="manifest" href="site.webmanifest">
  <link rel="shortcut icon" href="favicon.ico">
  <link rel="stylesheet" href="styles.css">
  <style>
    /* æ‰¹æ³¨ç³»ç»Ÿæ ·å¼ */
    .annotation-container {
      position: relative;
      display: inline;
    }

    .annotation-target {
      position: relative;
      display: inline-block;
      padding: 2px 6px;
    }

    .annotation-svg {
      position: absolute;
      top: -20px;
      left: -10px;
      pointer-events: none;
      z-index: 10;
    }

    /* åœ†åœˆå’Œçº¿æ¡æ ·å¼ */
    .annotation-circle {
      fill: none;
      stroke: #d97706;
      stroke-width: 2.5;
      stroke-dasharray: 4, 3;
      filter: drop-shadow(0 2px 4px rgba(217, 119, 6, 0.5));
    }

    .annotation-line {
      stroke: #d97706;
      stroke-width: 2.5;
      fill: none;
      marker-end: url(#arrowhead);
      stroke-dasharray: 5, 3;
      animation: drawLine 0.8s ease-in-out;
    }

    @keyframes drawLine {
      from {
        stroke-dashoffset: 100;
      }
      to {
        stroke-dashoffset: 0;
      }
    }

    .annotation-arrow {
      fill: #d97706;
      filter: drop-shadow(0 1px 2px rgba(217, 119, 6, 0.5));
    }

    .annotation-label {
      position: absolute;
      background: #fef3c7;
      border: 2px solid #d97706;
      border-radius: 6px;
      padding: 6px 10px;
      font-size: 0.85rem;
      font-weight: 700;
      color: #b45309;
      white-space: nowrap;
      box-shadow: 0 4px 12px rgba(217, 119, 6, 0.4);
      z-index: 11;
    }

    .highlight-term {
      display: inline-block;
      position: relative;
      padding: 0 4px;
      background: rgba(233, 180, 131, 0.15);
      border-radius: 3px;
      color: #d97706;
      font-weight: 700;
      transition: all 0.3s ease;
    }

    .highlight-term:hover {
      background: rgba(233, 180, 131, 0.25);
      color: #b45309;
    }

    .code-label {
      position: relative;
      margin: 20px 0;
      padding: 0;
    }

    .code-label-title {
      font-size: 0.9rem;
      font-weight: 600;
      color: #4f7398;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .code-label-title::before {
      content: 'â—€';
      font-size: 1.1em;
    }

    .code-label.accent-orange .code-label-title {
      color: #d97706;
    }

    .code-label.accent-orange .code-label-content {
      border-left-color: #d97706;
    }

    .code-label-content {
      border-left: 4px solid #4f7398;
      background: #f9fafb;
      padding: 12px;
      border-radius: 6px;
      overflow-x: auto;
      position: relative;
    }

    .code-label-content::before {
      content: attr(data-label);
      position: absolute;
      top: -25px;
      left: 0;
      font-size: 0.8rem;
      color: #999;
      font-weight: 500;
    }

    .code-label pre {
      margin: 0;
      font-size: 0.9rem;
    }

    .pointer-box {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      margin: 8px 0;
      border-radius: 6px;
      background: rgba(233, 180, 131, 0.1);
      border: 2px solid rgba(233, 180, 131, 0.3);
      font-size: 0.9rem;
      font-weight: 600;
      color: #d97706;
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .pointer-box:hover {
      background: rgba(233, 180, 131, 0.2);
      border-color: rgba(233, 180, 131, 0.6);
      transform: translateX(4px);
    }

    .pointer-arrow {
      font-size: 1.2em;
      animation: bounce 1s infinite;
    }

    @keyframes bounce {
      0%, 100% { transform: translateX(0); }
      50% { transform: translateX(4px); }
    }

    .annotation-target:hover .annotation-circle {
      stroke-width: 3;
      filter: drop-shadow(0 4px 8px rgba(233, 180, 131, 0.6));
    }
  </style>
  <script defer src="script.js"></script>
</head>

<body class="article-page">
  <div class="site-shell">
    <header class="site-header">
      <a class="brand" href="./index.html">SuyuOri.log</a>
      <nav class="site-nav" aria-label="ä¸»å¯¼èˆª">
        <a href="./index.html#posts">æ–‡ç« </a>
        <a href="./index.html#about">å…³äº</a>
        <a href="./index.html#contact">è”ç³»</a>
      </nav>
      <a class="github-link" href="https://github.com/SuyuOri" target="_blank" rel="noreferrer">GitHub</a>
    </header>

    <main class="article-layout">
      <nav class="article-nav" aria-label="Breadcrumb">
        <a class="back-link" href="./index.html">â† è¿”å›é¦–é¡µ</a>
        <span class="crumb-divider" aria-hidden="true">/</span>
        <span class="crumb-current">æŠ€æœ¯é•¿æ–‡</span>
      </nav>

      <article class="article-detail">
        <p class="section-label">é•¿æ–‡ Â· Proximal Policy Optimization</p>
        <h1>PPO ä»£ç è§£è¯»</h1>
        <p class="article-meta">Draft Â· 2025-11-16 Â· Reinforcement Learning Notes</p>

        <p class="article-intro">
          è¿™ç¯‡ç¬”è®°æ•´ç†äº† PPO (Proximal Policy Optimization) åœ¨å¼ºåŒ–å­¦ä¹ è®­ç»ƒä¸­çš„å…³é”®æƒ³æ³•â€”â€”å®ƒå¦‚ä½•åœ¨ä¿æŒæ ·æœ¬æ•ˆç‡çš„åŒæ—¶ç¨³å®šè®­ç»ƒã€ä»¥åŠä»£ç é‡Œéœ€è¦æ³¨æ„çš„å®ç°ç»†èŠ‚ã€‚
        </p>

        <h2>ä¸ºä»€ä¹ˆé€‰æ‹© PPOï¼Ÿ</h2>
        <p>
          PPO é€šè¿‡å¯¹ç­–ç•¥æ›´æ–°è¿›è¡Œè£å‰ª (clipping) é™åˆ¶æ–°æ—§ç­–ç•¥çš„å·®è·ï¼Œå…¼é¡¾äº†è®­ç»ƒç¨³å®šæ€§ä¸æ ·æœ¬æ•ˆç‡ã€‚
          å®ƒæ²¿è¢­äº† TRPO â€œä¿¡èµ–åŸŸâ€ çš„æ€æƒ³ï¼Œå´é¿å…äº†æ˜‚è´µçš„äºŒé˜¶ä¼˜åŒ–ã€‚æ ¸å¿ƒç›®æ ‡å‡½æ•°ï¼š
        </p>
        <p class="formula">L<sup>CLIP</sup>(Î¸) = E_t[ min(r_t(Î¸) Ã‚_t, clip(r_t(Î¸), 1-Îµ, 1+Îµ) Ã‚_t) ]</p>
        <p>å…¶ä¸­ r_t(Î¸) = Ï€_Î¸(a_t|s_t) / Ï€<sub>Î¸_old</sub>(a_t|s_t)ï¼ŒÃ‚_t é‡‡ç”¨ GAE ä¼°è®¡ã€‚</p>

        <h2>ç®—æ³•æµç¨‹</h2>
        <ol>
          <li>æ”¶é›† N æ¡è½¨è¿¹ï¼Œè·å¾— (s_t, a_t, r_t)ã€‚</li>
          <li>ä½¿ç”¨ GAE è®¡ç®—ä¼˜åŠ¿ï¼šÃ‚_t = Î£ (Î³Î»)^l Î´_{t+l}ã€‚</li>
          <li>æ„é€ è£å‰ªç›®æ ‡ï¼Œæ‰§è¡Œå¤šè½® epoch + mini-batch æ›´æ–°ã€‚</li>
          <li>åŒæ—¶ä¼˜åŒ– value loss ä¸ç†µæƒ©ç½šï¼Œä¿æŒæ¢ç´¢ã€‚</li>
        </ol>

        <h2>PyTorch é£æ ¼ä¼ªä»£ç </h2>
        
        <div class="code-label">
          <div class="code-label-title">ğŸ“ ä»£ç ç‰‡æ®µ B: æ¦‚ç‡æ¯”ç‡è®¡ç®—</div>
          <div class="code-label-content" id="ratio-calc">
            <pre><code>for epoch in range(update_epochs):
    minibatches = rollout.sample_batches(batch_size)
    for batch in minibatches:
        obs, act, old_logp, returns, adv = batch

        logp, value = policy.evaluate(obs, act)
        <span class="highlight-term">ratio = (logp - old_logp).exp()  # â† æ–°æ—§ç­–ç•¥æ¦‚ç‡æ¯”</span></code></pre>
          </div>
        </div>

        <div class="code-label accent-orange">
          <div class="code-label-title">â­ ä»£ç ç‰‡æ®µ A: è£å‰ªæŸå¤±å‡½æ•°ï¼ˆæ ¸å¿ƒï¼‰</div>
          <div class="code-label-content" id="clip-loss">
            <pre><code>        unclipped = ratio * adv
        <span class="highlight-term">clipped = ratio.clamp(1 - clip_coef, 1 + clip_coef) * adv</span>
        
        # â˜… è¿™æ­£æ˜¯ä¿è¯ <span class="annotation-target">
          <span class="highlight-term">è®­ç»ƒç¨³å®šæ€§</span>
          <svg class="annotation-svg" width="150" height="60" viewBox="0 0 150 60">
            <circle cx="45" cy="25" r="30" class="annotation-circle" />
            <path d="M 75 25 L 110 15" class="annotation-line" />
            <text x="85" y="8" font-size="10" fill="#d97706" font-weight="600">è£å‰ªæœºåˆ¶</text>
          </svg>
        </span> â˜…
        policy_loss = -torch.min(unclipped, clipped).mean()</code></pre>
          </div>
        </div>

        <p>ç»§ç»­ä¼˜åŒ–è¿‡ç¨‹ï¼š</p>
        <pre><code>        value_loss = 0.5 * (returns - value).pow(2).mean()
        entropy_loss = -entropy_coef * policy.entropy(obs).mean()

        loss = policy_loss + value_coef * value_loss + entropy_loss
        optimizer.zero_grad()
        loss.backward()
        torch.nn.utils.clip_grad_norm_(policy.parameters(), 0.5)
        optimizer.step()</code></pre>

        <h2>å·¥ç¨‹ç¬”è®°</h2>
        <ul>
          <li>ä¼˜åŠ¿å½’ä¸€åŒ–ï¼šå¯¹ Ã‚_t åšé›¶å‡å€¼å•ä½æ–¹å·®ï¼Œè®­ç»ƒæ›´ç¨³å¥ã€‚</li>
          <li>å­¦ä¹ ç‡è°ƒåº¦ï¼šçº¿æ€§é€€ç«é…åˆ clip èŒƒå›´ï¼Œå‡å°‘æŠ–åŠ¨ã€‚</li>
          <li>Buffer ç»†èŠ‚ï¼šç¼“å­˜æ—§ç­–ç•¥ log probabilityï¼Œvalue loss ä¹Ÿå¯ä»¥åŠ å…¥ clipã€‚</li>
        </ul>

        <p class="article-note">å®Œæ•´ Typst æ’ç‰ˆç¨¿ä½äº <code>blog/ppo-code-walkthrough.typ</code>ï¼Œå¯è¿è¡Œ
          <code>typst compile blog/ppo-code-walkthrough.typ blog/ppo-code-walkthrough.pdf</code> å¯¼å‡º PDFã€‚</p>
      </article>

      <div class="article-actions">
        <a class="article-button" href="./blog/ppo-code-walkthrough.typ" download target="_blank" rel="noreferrer">ä¸‹è½½ Typst æºæ–‡ä»¶</a>
        <a class="article-button ghost" href="./index.html#posts">è¿”å›æ–‡ç« åˆ—è¡¨</a>
      </div>
    </main>

    <footer class="site-footer">
      <small>Â© <span id="year"></span> SuyuOri Â· Crafted with intent &amp; curiosity.</small>
    </footer>
  </div>
</body>

</html>
